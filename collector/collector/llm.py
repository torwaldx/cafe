import os

from langchain_core.output_parsers import JsonOutputParser
from langchain_core.prompts import ChatPromptTemplate
from langchain_openai import ChatOpenAI


class LanguageModel:
    def __init__(self):
        api_base = os.getenv("OPENAI_API_BASE", "https://api.openai.com/v1")

        self.llm = ChatOpenAI(
            openai_api_base=api_base,
            model_name="gpt-4o-mini",
            temperature=0.0,
        )

        self.get_info_chain = self._get_info_extraction_chain()

    def _get_description_generation_chain(self):
        system_message = """Ð¢Ñ‹ - ÑƒÐ¼Ð½Ñ‹Ð¹ Ð˜Ð˜ Ð¿Ð¾Ð¼Ð¾Ñ‰Ð½Ð¸Ðº. Ð¢Ñ‹ Ð¿Ð¾Ð¼Ð¾Ð³Ð°ÐµÑˆÑŒ Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð·Ð°Ð²ÐµÐ´ÐµÐ½Ð¸Ñ.
ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð´Ð¾Ð»Ð¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ Ð¾ÑÐ½Ð¾Ð²Ð°Ð½Ð¾ Ð½Ð° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¾Ð¼ Ñ‚ÐµÐºÑÑ‚Ðµ, ÑÐ¾ÑÑ‚Ð¾ÑÑ‚ÑŒ Ð¸Ð· Ð´Ð²ÑƒÑ…-Ñ‚Ñ€ÐµÑ… Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¹ Ð² Ð½ÐµÐ¾Ñ„Ð¸Ñ†Ð¸Ð°Ð»ÑŒÐ½Ð¾Ð¼ ÑÑ‚Ð¸Ð»Ðµ.
ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð½Ðµ Ð´Ð¾Ð»Ð¶Ð½Ð¾ ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ Ð½ÐµÐ³Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ðµ Ð¾Ñ†ÐµÐ½ÐºÐ¸, ÑÐ»Ð¾Ð²Ð° Ð¸ Ð¾Ñ‚Ð·Ñ‹Ð²Ñ‹.
ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ ÑÐ²ÐµÐ´ÐµÐ½Ð¸Ñ Ð¾ ÐºÑƒÑ…Ð½Ðµ (Ð¾ÑÐ¾Ð±ÐµÐ½Ð½Ð¾ÑÑ‚ÑÑ… Ð±Ð»ÑŽÐ´), ÐµÑÐ»Ð¸ Ð¸Ñ… Ð¼Ð¾Ð¶Ð½Ð¾ Ð¸Ð·Ð²Ð»ÐµÑ‡ÑŒ Ð¸Ð· Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð½Ð¾Ð³Ð¾ Ñ‚ÐµÐºÑÑ‚Ð°.
Ð’ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð½Ðµ Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ Ð²ÐºÐ»ÑŽÑ‡Ð°Ñ‚ÑŒ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð¸ Ð°Ð´Ñ€ÐµÑ Ð·Ð°Ð²ÐµÐ´ÐµÐ½Ð¸Ñ.
Ð¢Ð²Ð¾Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð·Ð°Ð²ÐµÐ´ÐµÐ½Ð¸Ñ, Ð±ÐµÐ· Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ñ… Ð¿Ð¾ÑÑÐ½ÐµÐ½Ð¸Ð¹.
"""

        prompt = ChatPromptTemplate(
            [
                ("system", system_message),
                ("human", "{user_request}"),
            ]
        )

        chain = prompt | self.llm

        return chain

    def _get_info_extraction_chain(self):
        system_message = """Ð¢Ñ‹ - ÑƒÐ¼Ð½Ñ‹Ð¹ Ð˜Ð˜ Ð¿Ð¾Ð¼Ð¾Ñ‰Ð½Ð¸Ðº.
Ð¢Ñ‹ Ð¿Ð¾Ð¼Ð¾Ð³Ð°ÐµÑˆÑŒ Ð¸Ð· Ñ‚ÐµÐºÑÑ‚Ð° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¸Ð·Ð²Ð»ÐµÑ‡ÑŒ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ, ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑŽ Ð¸ Ð°Ð´Ñ€ÐµÑ Ð·Ð°Ð²ÐµÐ´ÐµÐ½Ð¸Ñ Ð¾Ð±Ñ‰ÐµÑÑ‚Ð²ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð¿Ð¸Ñ‚Ð°Ð½Ð¸Ñ.
Ð—Ð°Ð²ÐµÐ´ÐµÐ½Ð¸Ñ Ð½Ðµ Ð¾Ñ‚Ð½Ð¾ÑÑÑ‰Ð¸ÐµÑÑ Ðº ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸ Ð¾Ð±Ñ‰ÐµÑÑ‚Ð²ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð¿Ð¸Ñ‚Ð°Ð½Ð¸Ñ Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ Ð¿Ñ€Ð¾Ð¸Ð³Ð½Ð¾Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹.
ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð¸ Ð°Ð´Ñ€ÐµÑ Ð·Ð°Ð²ÐµÐ´ÐµÐ½Ð¸Ñ Ð´Ð¾Ð»Ð¶Ð½Ñ‹ ÑÐ²Ð½Ñ‹Ð¼ Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð¼ ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒÑÑ Ð² Ñ‚ÐµÐºÑÑ‚Ðµ.
Ð•ÑÐ»Ð¸ Ð² ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¸ ÐµÑÑ‚ÑŒ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¹, Ñ‚Ð¾ Ð¾Ð½Ð¸ Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ Ñ€Ð°Ð·Ð´ÐµÐ»ÐµÐ½Ñ‹ Ð·Ð°Ð¿ÑÑ‚Ñ‹Ð¼Ð¸. ÐŸÐµÑ€Ð²Ð¾Ð¹ Ð² ÑÐ¿Ð¸ÑÐºÐµ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¹ Ð´Ð¾Ð»Ð¶Ð½Ð° Ð±Ñ‹Ñ‚ÑŒ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ñ, Ð½Ð°Ð¸Ð±Ð¾Ð»ÐµÐµ Ð¿Ð¾Ð´Ñ…Ð¾Ð´ÑÑ‰Ð°Ñ Ð¿Ð¾ ÑÐ¼Ñ‹ÑÐ»Ñƒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ.
ÐÐ´Ñ€ÐµÑ Ð´Ð¾Ð»Ð¶ÐµÐ½ ÑÐ¾ÑÑ‚Ð¾ÑÑ‚ÑŒ Ð¸Ð· Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ ÑƒÐ»Ð¸Ñ†Ñ‹ (Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾) Ð¸ Ð½Ð¾Ð¼ÐµÑ€Ð° Ð´Ð¾Ð¼Ð° Ð¸Ð»Ð¸ ÑÑ‚Ñ€Ð¾ÐµÐ½Ð¸Ñ (Ð¿Ð¾ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸).
Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð°Ð´Ñ€ÐµÑÐ° Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ Ð¸Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ñ‹ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ Ñ‚ÐµÑ… Ð·Ð°Ð²ÐµÐ´ÐµÐ½Ð¸Ð¹, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð½Ð°Ñ…Ð¾Ð´ÑÑ‚ÑÑ Ð² ÐœÐ¾ÑÐºÐ²Ðµ (Moscow, msk, ÐœÑÐº), Ð¿Ð¾ÑÑ‚Ð¾Ð¼Ñƒ, ÐµÑÐ»Ð¸ Ð² Ñ‚ÐµÐºÑÑ‚Ðµ Ð¿Ñ€Ð¾ÑÐ»ÐµÐ¶Ð¸Ð²Ð°ÐµÑ‚ÑÑ Ð¿Ñ€Ð¸Ð½Ð°Ð´Ð»ÐµÐ¶Ð½Ð¾ÑÑ‚ÑŒ Ð°Ð´Ñ€ÐµÑÐ° Ðº Ð´Ñ€ÑƒÐ³Ð¾Ð¼Ñƒ Ð³Ñ€Ñ€Ð¾Ð´Ñƒ, ÑÑ‚Ð¾Ñ‚ Ð°Ð´Ñ€ÐµÑ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð¿Ñ€Ð¾Ð¸Ð³Ð½Ð¾Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ð½.

Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ Ð¾Ñ‚Ð²ÐµÑ‚Ð°: JSON-Ð¾Ð±ÑŠÐµÐºÑ‚ Ñ ÐºÐ»ÑŽÑ‡Ð¾Ð¼ "items", ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‰Ð¸Ð¹ ÑÐ»Ð¾Ð²Ð°Ñ€ÑŒ Ñ Ð¿Ð¾Ð»ÑÐ¼Ð¸ "name" (Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð·Ð°Ð²ÐµÐ´ÐµÐ½Ð¸Ñ), "category" (ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ñ) Ð¸ "address" (Ð°Ð´Ñ€ÐµÑ).
Ð•ÑÐ»Ð¸ Ð¿Ð¾ ÐºÐ°ÐºÐ¾Ð¹-Ð»Ð¸Ð±Ð¾ Ð¿Ñ€Ð¸Ñ‡Ð¸Ð½Ðµ Ð½Ðµ ÑƒÐ´Ð°ÐµÑ‚ÑÑ Ð¾Ð´Ð½Ð¾Ð·Ð½Ð°Ñ‡Ð½Ð¾ Ð¸Ð· Ñ‚ÐµÐºÑÑ‚Ð° Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ, ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑŽ Ð¸Ð»Ð¸ Ð°Ð´Ñ€ÐµÑ Ð·Ð°Ð²ÐµÐ´ÐµÐ½Ð¸Ñ, Ñ‚Ð¾ Ð² ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ðµ Ð¾Ñ‚Ð²ÐµÑ‚Ð° Ð²ÐµÑ€Ð½Ð¸ Ð¿ÑƒÑÑ‚ÑƒÑŽ ÑÑ‚Ñ€Ð¾ÐºÑƒ.
ÐžÑ‚Ð²ÐµÑ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ ÑÑ‚Ñ€Ð¾Ð³Ð¾ JSON-Ð¾Ð±ÑŠÐµÐºÑ‚Ð¾Ð¼ Ð±ÐµÐ· Ð¿Ð¾ÑÑÐ½ÐµÐ½Ð¸Ð¹ Ð¸ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ð³Ð¾ Ñ‚ÐµÐºÑÑ‚Ð°.

ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹ Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð²:

Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ: "ÐÐ¾Ð²Ñ‹Ð¹ Ñ€ÐµÑÑ‚Ð¾Ñ€Ð°Ð½ Â«ÐÐ²Ñ€Ð¾Ñ€Ð°Â» Ð½Ð° Ð¦Ð²ÐµÑ‚Ð½Ð¾Ð¼ Ð±ÑƒÐ»ÑŒÐ²Ð°Ñ€Ðµ â€” ÑÑ‚Ð¾ Ñ‚Ñ€Ð¸ ÑÑ‚Ð°Ð¶Ð°, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð² ÑÐ²Ð¾Ðµ Ð²Ñ€ÐµÐ¼Ñ Ð½Ð°Ð´ÐµÐ»Ð°Ð»Ð¸ Ð¼Ð½Ð¾Ð³Ð¾ ÑˆÑƒÐ¼Ð°. Ð’Ð½ÐµÑˆÐ½Ðµ ÑÐ¿Ð¾ÐºÐ¾Ð¹Ð½Ñ‹Ð¹ Ð¸Ð½Ñ‚ÐµÑ€ÑŒÐµÑ€, Ð±Ð»Ð¸Ð¶Ðµ Ðº ÑÐ´ÐµÑ€Ð¶Ð°Ð½Ð½Ð¾Ð¹ ÐºÐ»Ð°ÑÑÐ¸ÐºÐµ, Ñ‡ÐµÐ¼ Ðº Â«Ð¡Ð°Ñ…Ð°Ð»Ð¸Ð½ÑƒÂ» â€” Ð½Ð¾ ÑÑ‚Ð¾ Ð½Ð° Ð¼Ð¾Ð¹, ÑÐºÑ€Ð¾Ð¼Ð½Ñ‹Ð¹ Ð²Ð·Ð³Ð»ÑÐ´
Avrora â€” Ð¼ÐµÑÑ‚Ð¾, ÐºÑƒÐ´Ð° ÑÑ‚Ð¾Ð¸Ñ‚ Ð¿Ñ€Ð¸Ð¹Ñ‚Ð¸ Ð±ÐµÐ· Ð¾Ð¶Ð¸Ð´Ð°Ð½Ð¸Ð¹. Ð’Ð½ÑÑ‚Ð½Ð°Ñ, Ð½Ð¾ Ð½Ðµ Ð¸Ð´ÐµÐ°Ð»ÑŒÐ½Ð°Ñ ÐºÑƒÑ…Ð½Ñ, Ð¸Ð½Ð¾Ð³Ð´Ð° Ð¿Ð¾Ñ…Ð¾Ð¶Ð°Ñ Ð½Ð° ÑÐ°Ð¼Ð¾Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€ Ð¾Ñ‚ AVA Team
ÐŸÑ€Ð¸ÐµÐ¼Ð»ÐµÐ¼Ñ‹Ðµ Ñ†ÐµÐ½Ñ‹, Ð³Ñ€Ð°Ð¼Ð¾Ñ‚Ð½Ð¾Ðµ Ð¾Ð±ÑÐ»ÑƒÐ¶Ð¸Ð²Ð°Ð½Ð¸Ðµ. ÐÐµ ÑÐºÐ°Ð·Ð°Ñ‚ÑŒ, Ñ‡Ñ‚Ð¾ Ð·Ð´ÐµÑÑŒ Ð²Ð°Ñ Ð¶Ð´ÐµÑ‚ Ð¾Ñ‚ÐºÑ€Ð¾Ð²ÐµÐ½Ð¸Ðµ, Ð½Ð¾ ÑÑ‚Ð°Ð±Ð¸Ð»ÑŒÐ½Ð¾Ðµ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð² ÐºÑ€Ð°ÑÐ¸Ð²Ñ‹Ñ… Ð´ÐµÐºÐ¾Ñ€Ð°Ñ†Ð¸ÑÑ… â€” Ð²Ð¿Ð¾Ð»Ð½Ðµ.
ðŸ´ Ð¦Ð²ÐµÑ‚Ð½Ð¾Ð¹ Ð±ÑƒÐ»ÑŒÐ²Ð°Ñ€, 2 
ðŸ“ž 8 (495) 846-93-66
"
ÐžÑ‚Ð²ÐµÑ‚:
{{
    "items": {{
        "name": "ÐÐ²Ñ€Ð¾Ñ€Ð°",
        "category": "Ñ€ÐµÑÑ‚Ð¾Ñ€Ð°Ð½",
        "address": "Ð¦Ð²ÐµÑ‚Ð½Ð¾Ð¹ Ð±ÑƒÐ»ÑŒÐ²Ð°Ñ€, 2"
    }}
}}


Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ: " ÐÐ° Ð¾Ð±ÐµÐ´ Ð² Ð½Ð°ÑˆÐµÐ¼ Ñ€ÐµÑÑ‚Ð¾Ñ€Ð°Ð½Ðµ ÑÐµÐ³Ð¾Ð´Ð½Ñ Ð²Ñ‹Ð³Ð¾Ð´Ð½Ð¾Ðµ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ â€” Ð»Ð¾Ð²Ð¸Ñ‚Ðµ ÑÐºÐ¸Ð´ÐºÐ¸ Ð½Ð° Ð¿Ð¾ÐºÑƒÐ¿ÐºÐ¸ Ð´Ð¾ 50%

ÐšÑ€ÑƒÑ‚Ð¸Ñ‚Ðµ ÐºÐ¾Ð»ÐµÑÐ¾ (https://plus.yandex.ru/x5?utm_source=plus&utm_medium=smm_paid&utm_campaign=MSCAMP-632_wheel_march&utm_content=posev_tg&utm_term=vkusonomika&erid=2VtzquveYNL) Ð¸ Ð·Ð°Ð±Ð¸Ñ€Ð°Ð¹Ñ‚Ðµ Ð´Ð¾ 100 000 Ð±Ð°Ð»Ð»Ð¾Ð² ÐŸÐ»ÑŽÑÐ°, ÑÐºÐ¸Ð´ÐºÐ¸ Ð´Ð¾ 50% Ð² Â«ÐŸÐµÑ€ÐµÐºÑ€Ñ‘ÑÑ‚ÐºÐµÂ», Ð´Ð¾ 25% Ð² Â«ÐŸÑÑ‚Ñ‘Ñ€Ð¾Ñ‡ÐºÐµÂ» Ð¸ Ð´Ñ€ÑƒÐ³Ð¸Ðµ Ð¿Ð¾Ð´Ð°Ñ€ÐºÐ¸. ÐÐºÑ†Ð¸Ñ Ð´ÐµÐ¹ÑÑ‚Ð²ÑƒÐµÑ‚ Ð¾Ð´Ð¸Ð½ Ð´ÐµÐ½ÑŒ Ð´Ð»Ñ Ð¿Ð¾Ð´Ð¿Ð¸ÑÑ‡Ð¸ÐºÐ¾Ð²"
"
ÐžÑ‚Ð²ÐµÑ‚:
{{
    "items": {{
        "name": "",
        "category": "Ñ€ÐµÑÑ‚Ð¾Ñ€Ð°Ð½",
        "address": ""
    }}
}}

Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ: "Fitz Ð”Ð¶Ð¸Ð½ Ð¾Ñ‚ÐºÑ€Ñ‹Ð»Ð¸ÑÑŒ!

Ð ÐµÑÑ‚Ð¾Ñ€Ð°Ð½-Ð±Ð°Ñ€ Ñ ÐµÐ²Ñ€Ð¾Ð¿ÐµÐ¹ÑÐºÐ¾Ð¹ ÐºÑƒÑ…Ð½ÐµÐ¹ Ð¸ Ð°Ð²Ñ‚Ð¾Ñ€ÑÐºÐ¸Ð¼Ð¸ ÐºÐ¾ÐºÑ‚ÐµÐ¹Ð»ÑÐ¼Ð¸! ÐžÑ‚Ñ‚ÑÐ½Ð¸ÑÑŒ Ñƒ ÑÑ‚Ð¾Ð¹ÐºÐ¸!

â—»ï¸ ÐœÑÑÐ½Ð¸Ñ†ÐºÐ°Ñ, 14/2 c1
â—»ï¸ Ð Ð°Ð±Ð¾Ñ‚Ð°ÑŽÑ‚ Ñ 18:00
â—»ï¸ ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½Ð¾ÑÑ‚Ð¸ (https://fitzginbar.ru/)

#ÐžÑ‚ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ #ÐœÐ¾ÑÐºÐ²Ð° #Ð¦ÐÐž
"
ÐžÑ‚Ð²ÐµÑ‚:
{{
    "items": {{
        "name": "Fitz Ð”Ð¶Ð¸Ð½",
        "category": "Ð±Ð°Ñ€, Ñ€ÐµÑÑ‚Ð¾Ñ€Ð°Ð½",
        "address": "ÐœÑÑÐ½Ð¸Ñ†ÐºÐ°Ñ, 14/2 c1"
    }}
}}
    """

        prompt = ChatPromptTemplate(
            [
                ("system", system_message),
                ("human", "{user_request}"),
            ]
        )

        parser = JsonOutputParser()

        chain = prompt | self.llm | parser

        return chain

    def _is_valid_types(self, response):
        if type(response) is not dict:
            return False
        if response.get("items") is None:
            return False
        if response["items"].get("name") is None or response["items"].get("address") is None:
            return False
        if type(response["items"]["name"]) is not str or type(response["items"]["address"]) is not str:
            return False
        if len(response["items"]["name"]) == 0 or len(response["items"]["address"]) == 0:
            return False

        return True

    def _is_info_in_text(self, response, text):
        return True
        words_list = response["items"]["address"].split() + response["items"]["name"].split()
        return all(words_list[i] in text for i in range(len(words_list)))

    def _is_valid_info(self, response, text):
        if not self._is_valid_types(response):
            return False
        if not self._is_info_in_text(response, text):
            return False
        return True

    def get_info(self, text: str):
        response = self.get_info_chain.invoke({"user_request": text})
        if self._is_valid_info(response, text):
            return response["items"]
        return {"name": None, "address": None}

    def get_description(self, *args) -> str:
        request = ".\n".join(str(arg) for arg in args if arg is not None)
        chain = self._get_description_generation_chain()
        return chain.invoke({"user_request": request}).content
